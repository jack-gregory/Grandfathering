---
title:  "Grandfathering balance table"
author: "Jack Gregory"
date:   "15 September 2021"
output:
  bookdown::html_document2:
    toc:          yes
    toc_depth:    2
    toc_float:    yes
    fig_caption:  yes
    df_print:     paged
    highlight:    textmate
    keep_md:      true
  pdf_document:
    latex_engine: pdflatex
    highlight:    haddock
    keep_md:      true
---
___

```{r preamble, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = TRUE,
  message=FALSE, 
  warning=FALSE,
  fig.topcaption=TRUE, 
  fig.show="hold",
  fig.align="center",
  fig.width=7, 
  fig.height=4.6)


## Initiate 
## ... Packages
source(here::here("src/preamble.R"))

install.packages(setdiff(c("haven","sf","zip"), rownames(installed.packages())))
library(haven)
library(sf)
library(zip)

## ... Functions
source(here("src/def_paths.R"))
source(here("src/text_colour.R"))

## ... Files
l.file <- list(
  gf_raw = path(l.path$data, "gf_original/in_regression_vars_BP.csv"),
  gf_cln = path(l.path$data, "gf_original/regressions_ready_data.dta"),
  epa_eia_xwalk = path(l.path$data, "epa/epa_eia_crosswalk.csv"),
  gf_cems_xwalk = path(l.path$data, "gf_cems_xwalk.csv"),
  epa = path(l.path$data, "epa/Facility_Attributes.zip"),
  state = path(l.path$data, "eia/shp/USA_States_Generalized.shp")
)
```

```{r theme, include=FALSE}

# theme_sulfur <- function() {
#   theme_classic() +
#   theme(strip.background = element_rect(fill="grey85", color=NA),
#         axis.line.y = element_blank(),
#         axis.ticks.y = element_blank(),
#         panel.grid.major.y = element_line(colour="grey85", size=0.3),
#         panel.grid.minor.y = element_line(colour="grey85", size=0.3),
#         axis.line.x = element_line(size=0.4),
#         axis.ticks.x = element_line(size=0.4),
#         legend.position = "right",
#         plot.caption = element_text(hjust=0))
# }

theme_maps <- function() {
  theme_void() +
  theme(legend.position = "right",
        legend.text = element_text(size=7),
        plot.caption = element_text(hjust=0))
} 
```

# Objective

This workbook forms a part of the analysis related to the Grandfathering project.  It prepares a data balance table using cleaned grandfathering data, EPA-EIA crosswalk, and EPA facility attributes.

The remainder of this workbook is organized as follows.  First, we import the necessary data.  Next, we clean the data while also providing a running commentary for replication.  Finally, we prepare the balance table and export it as a tex file.


# Import

We import grandfathering, EPA-EIA crosswalk, EPA facility and various spatial data.


## Boiler characteristics

Grandfathering ...

```{r data-gf}

## Import GF dataset
df.gf_cln <- read_dta(l.file$gf_cln) %>%
  filter(!(year<1985 | year==2006 | year==2018)) %>%
  filter(plant_code!=10673) %>%
  select(year,
         states,
         ORISPL = plant_code,
         BOILERID = boiler_id,
         grand_NSR_const,
         ut_type,
         so2_nonattain,
         leg_lbs_mmbtu_calc,
         age,
         inservice_y,
         max_boi_nameplate,
         ARP_subject,
         ARPprice_sp,
         survive,
         DURATION,
         GLOAD,
         HEAT,
         SO2_MASS,
         SO2,
         sulfur_dist)

## Extract utility type definitions
utility_type <- attributes(df.gf_cln$ut_type)$labels

## Convert GF dataset to cross-section
df.gf_cln <- df.gf_cln %>%
  group_by(ORISPL, BOILERID) %>%
  mutate(SO2_RATE = SO2_MASS / HEAT,
         HEATRATE = HEAT / GLOAD) %>%
  mutate_at(vars(GLOAD, SO2_RATE, HEATRATE), ~ifelse(HEATRATE>15, NA, .)) %>%
  fill(ut_type, .direction="downup") %>%
  summarise(STATE = first(states),
            GF = mean(grand_NSR_const, na.rm=TRUE),
            UTILITY_TYPE = first(ut_type),
            NONATTAIN = mean(so2_nonattain, na.rm=TRUE),
            ARP = max(ARP_subject, na.rm=TRUE),
            LOCALREG = mean(leg_lbs_mmbtu_calc, na.rm=TRUE),
            CAPACITY = min(max_boi_nameplate, na.rm=TRUE),
            AGE = mean(age, na.rm=TRUE),
            INSERVICE = mean(inservice_y, na.rm=TRUE),
            RETIREMENT = max(year, na.rm=TRUE),
            RETIRE = sum((survive==0), na.rm=TRUE),
            DURATION = mean(DURATION, na.rm=TRUE),
            GLOAD = mean(GLOAD, na.rm=TRUE),
            HEATRATE = mean(HEATRATE, na.rm=TRUE),
            SO2_RATE = mean(SO2_RATE, na.rm=TRUE),
            SULFUR_DIST = mean(sulfur_dist, na.rm=TRUE),
            .groups="drop") %>%
  mutate_all(~ifelse(. %in% c(NaN, -Inf, Inf), NA, .)) %>%
  mutate(RETIREMENT = ifelse(RETIREMENT==2017 & RETIRE!=1, NA, RETIREMENT)) %>%
  ungroup()
```


## Plant coordinates

There are multiple sources for plant geographic locations:

- Grandfathering dataset;
- EPA facility attributes; and,
- EIA860.

The source for the grandfathering dataset is most likely the EIA.  Here, we rely on the grandfathering and EPA datasets.  `r text_colour(colour="red", text="In future versions, we should incorportate EIA860 coordinates in order to avoid using county centroids.")`

We first import the grandfathering data, where we summarize it at the ORISPL level.

```{r data-gf}

## Import gf coordinate data
df.gf_raw <- read_csv(l.file$gf_raw) %>%
  select(ORISPL = plant_code, 
       LAT = plt_latitude, 
       LON = plt_longitude,
       COUNTY_LAT = cty_lon,
       COUNTY_LON = cty_lat) %>%
  filter(ORISPL!=10673)

## Determine distinct ORISPL and county coordinates
df.gf_county <- df.gf_raw %>%
  distinct(ORISPL, COUNTY_LAT, COUNTY_LON) %>%
  group_by(ORISPL) %>%
  summarise_all(first) %>%
  ungroup()

## Create plant coordinate dataframe
df.gf_raw <- df.gf_raw %>%
  select(-starts_with("COUNTY_")) %>%
  mutate(LON = ifelse(LON>0, NA, LON)) %>%
  filter(!(is.na(LAT) | is.na(LON))) %>%
  distinct() %>%
  group_by(ORISPL) %>%
  summarise_all(first) %>%
  ungroup() %>%
  full_join(df.gf_county, by=c("ORISPL")) %>%
  arrange(ORISPL)
```

We next import the EPA data and summarize at the ORISPL level.

```{r data-epa}

## Unzip EPA facility data
epa_file <- zip::zip_list(l.file$epa) %>%
  filter(str_detect(filename, "^facility")) %>%
  pull(filename)
zip::unzip(l.file$epa, file=epa_file, exdir=path(l.path$data, "epa"))

## Import EPA coordinate data
df.epa <- read_csv(path(l.path$data, "epa", epa_file)) %>%
  select(ORISPL = `Facility ID (ORISPL)`, 
       LAT_EPA = `Facility Latitude`, 
       LON_EPA = `Facility Longitude`) %>%
  distinct() %>%
  arrange(ORISPL)

## Remove EPA facility data
fs::file_delete(path(l.path$data, "epa", epa_file))
```

Finally, we import the EPA-EIA crosswalk data and summarize at the ORISPL level.

```{r data-epa-eia-xwalk}

df.epa_eia_xwalk <- read_csv(l.file$epa_eia_xwalk) %>%
  select(ORISPL = CAMD_PLANT_ID,
         CAMD_LATITUDE,
         CAMD_LONGITUDE,
         EIA_LATITUDE,
         EIA_LONGITUDE) %>%
  group_by(ORISPL) %>%
  summarise_at(vars(starts_with("CAMD_"), starts_with("EIA_")), first) %>%
  ungroup()
```


## State shapefiles

The state spatial data is sourced from the [EIA](https://atlas.eia.gov/datasets/esri::usa-states-generalized).  While, only the shp file is named below, note that its import also requires equivalently named dbf, prj, and shx files in the folder.

```{r sf-state, fig.cap="State shapefile"}

## Import state shapefile
df.state <- read_sf(l.file$state) %>%
  filter(!(STATE_ABBR %in% c("AK","HI")))

## Display coordinate reference system
st_crs(df.state)

## Plot
ggplot(data=df.state) +
  geom_sf(color="grey40", fill="grey90", size=0.3) +
  coord_sf()
```


# Cleaning

...


## Plant coordinates

We first construct the plant latitude and longitude coordinates using the following concordance:

1. Grandfathering plant coordinates;
2. EIA coordinates from EPA-EIA crosswalk;
3. EPA facility attributes; 
4. EPA coordinates from EPA-EIA crosswalk; and,
5. Grandfathering county centroids.

The base values are from the grandfathering dataset, which are sourced from EIA-860.  For any missing values, we replace them with coordinates from EPA facility attributes.  Finally, for any remaining missing values, we adopt county centroids as calculated in the grandfathering dataset.  `r text_colour(colour="red", text="County centroids should eventually be superceded by EIA860 plant coordinates.")`

```{r plant-coords}

## Clean plant coordinates and convert to sf
df.plant <- df.gf_raw %>%
  left_join(df.epa, by=c("ORISPL")) %>%
  left_join(df.epa_eia_xwalk, by=c("ORISPL")) %>%
  mutate(LAT = case_when(!is.na(LAT) ~ LAT,
                         is.na(LAT) & !is.na(EIA_LATITUDE) ~ EIA_LATITUDE,
                         is.na(LAT) & is.na(EIA_LATITUDE) & !is.na(LAT_EPA) ~ LAT_EPA,
                         is.na(LAT) & is.na(EIA_LATITUDE) & is.na(LAT_EPA) & !is.na(EIA_LATITUDE) ~
                           EIA_LATITUDE,
                         TRUE ~ COUNTY_LAT),
         LON = case_when(!is.na(LON) ~ LON,
                         is.na(LON) & !is.na(EIA_LONGITUDE) ~ EIA_LONGITUDE,
                         is.na(LON) & is.na(EIA_LONGITUDE) & !is.na(LON_EPA) ~ LON_EPA,
                         is.na(LON) & is.na(EIA_LONGITUDE) & is.na(LON_EPA) & !is.na(EIA_LONGITUDE) ~
                           EIA_LONGITUDE,
                         TRUE ~ COUNTY_LON),
         LATITUDE = LAT,
         LONGITUDE = LON) %>%
  select(ORISPL, LAT, LON, LATITUDE, LONGITUDE) %>%
  right_join(df.gf_cln %>%
              group_by(ORISPL) %>%
              summarise(N = n(),
                        GF = max(GF, na.rm=TRUE),
                        .groups="drop"),
            by=c("ORISPL")) %>%
  st_as_sf(coords = c("LONGITUDE","LATITUDE"), crs=st_crs(df.state), agr="constant")

## Display coordinate reference system
st_crs(df.plant)

## Plot
ggplot() +
  geom_sf(data=df.state, fill="grey85", color="grey95", size=0.3) +
  geom_sf(data=df.plant, aes(color=factor(GF, levels=c(0,1), labels=c("Not GF","GF")), size=N)) +
  scale_color_viridis_d(option="B", begin=0.25, end=0.85, alpha=0.3) +
  coord_sf() +
  labs(title="Coal-fired power plants",
       color="NSR",
       size="Boilers") +
  theme_maps()
```


## Boiler characteristics

...

```{r boiler-chars}

df.boiler <- df.gf_cln %>%
  left_join(df.plant %>%
              as_tibble() %>% 
              select(-N, -GF, -geometry), 
            by=c("ORISPL"))
```




# Analysis


```{r}

## NB - See <http://www.stat.yale.edu/Courses/1997-98/101/meancomp.htm>


levels <- c("NONATTAIN","ARP","LOCALREG","LAT","LON","CAPACITY","AGE","INSERVICE",
  "RETIREMENT","RETIRE","DURATION","GLOAD","HEATRATE","SO2_RATE","SULFUR_DIST","UT_C","UT_COM",
  "UT_F","UT_I","UT_IND","UT_M","UT_P","UT_Q","UT_S","N")
labels <- c("Nonattainment",
            "Acid Rain Program (ARP)",
            "Applicable Non-NSR Emission Standard [lbs/mmBTu]",
            "Latitude",
            "Longitude",
            "Capacity",
            "Age",
            "Inservice Year",
            "Retirement Year",
            "Retire",
            "Duration [hr/yr]",
            "Generation [GWh/yr]",
            "Heat Rate [mmBTu/MW]",
            "SO2 Emissions [lbs/mmBTu]",
            "Weighted Average Mine Sulfur Content [% weight]",
            "Share of Co-operatives",
            "Share of Commercial",
            "Share of Federal",
            "Share of Investor-Owned",
            "Share of Industrial",
            "Share of Municipal",
            "Share of Political",
            "Share of IPPs",
            "Share of State",
            "N")

df.bal_n <- df.boiler %>%
  group_by(GF) %>%
  summarise(N = n(), .groups="drop") %>%
  mutate(N = formatC(N, format="f", digits=0, big.mark=",")) %>%
  pivot_wider(names_from=GF, names_prefix="GF_", values_from="N") %>%
  mutate(VAR = "N",
         ORDER = 1) %>%
  select(VAR, ORDER, GF_1, GF_0)

df.bal <- df.boiler %>%
  mutate(GLOAD = GLOAD/10^3,
         UT_C = (UTILITY_TYPE==1),
         UT_COM = (UTILITY_TYPE==2),
         UT_F = (UTILITY_TYPE==3),
         UT_I = (UTILITY_TYPE==4),
         UT_IND = (UTILITY_TYPE==5),
         UT_M = (UTILITY_TYPE==6),
         UT_P = (UTILITY_TYPE==7),
         UT_Q = (UTILITY_TYPE==8),
         UT_S = (UTILITY_TYPE==9)) %>%
  select(-ORISPL, -BOILERID, -STATE, -UTILITY_TYPE) %>%
  pivot_longer(cols=-GF, names_to="VAR", values_to="VAL") %>%
  group_by(VAR, GF) %>%
  summarise(MEAN = mean(VAL, na.rm=TRUE),
            SD = sd(VAL, na.rm=TRUE),
            N = sum(!is.na(VAL), na.rm=TRUE),
            .groups="drop") %>%
  pivot_wider(id_cols=VAR, names_from=GF, values_from=c(MEAN, SD, N)) %>%
  mutate(DIFF = MEAN_1 - MEAN_0,
         TSTAT = (MEAN_1 - MEAN_0)/sqrt(SD_0^2/N_0 + SD_1^2/N_1),
         SIG = case_when(abs(TSTAT)>=3.291 ~ "***",
                         abs(TSTAT)>=2.576 ~ "**",
                         abs(TSTAT)>=1.960 ~ "*",
                         TRUE ~ "")) %>%
  mutate_at(vars(matches("MEAN|SD|DIFF|TSTAT")), ~formatC(., format="f", digits=2, big.mark=",")) %>%
  mutate_at(vars(starts_with("SD")), ~glue("({.})")) %>%
  mutate(DIFF = glue("{DIFF}{SIG}"),
         TSTAT = glue("[{TSTAT}]")) %>%
  select(-starts_with("N_"), -SIG) %>%
  pivot_longer(cols=matches("MEAN|SD|DIFF|TSTAT"), names_to="STAT", values_to="VAL") %>%
  separate(STAT, into=c("STAT","GF"), sep="_") %>%
  mutate(ORDER = case_when(STAT %in% c("MEAN","DIFF") ~ 1,
                           TRUE ~ 2)) %>%
  pivot_wider(id_cols=c(VAR, ORDER), names_from=GF, names_prefix="GF_", values_from=VAL) %>%
  rename(DIFF = GF_NA) %>%
  bind_rows(df.bal_n) %>%
  mutate(VAR = factor(VAR, levels=levels, labels=labels)) %>%
  arrange(VAR, ORDER) %>%
  mutate(VAR = as.character(VAR),
         VAR = ifelse(ORDER==2, NA, VAR)) %>%
  mutate_all(~ifelse(is.na(.), "", .)) %>%
  select(VAR, GF_1, GF_0, DIFF)
```



```{r}


df.bal %>%
  kable(format="latex", align="lrrr", booktabs=TRUE, linesep=c(""),
        caption="Average characteristics of boilers by NSR grandfathering status",
        col.names=c("","Grandfathered","Non-Granfathered","Difference")) 

```


# Export???

<!-- This section exports the cleaned sulfur data to a csv file: -->

<!-- ```{r sulfur-export} -->

<!-- readr::write_csv(df.distance %>% as_tibble() %>% select(-geometry),  -->
<!--                  l.file$out) -->
<!-- ``` -->



