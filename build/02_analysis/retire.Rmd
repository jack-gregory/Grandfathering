---
title:    "Grandfathering outputs"
subtitle: "Retirement map"
author:   "Jack Gregory"
date:     "25 September 2021"
output:
  bookdown::html_document2:
    toc:          yes
    toc_depth:    2
    toc_float:    yes
    fig_caption:  yes
    df_print:     paged
    highlight:    textmate
    keep_md:      true
  pdf_document:
    latex_engine: pdflatex
    highlight:    haddock
    keep_md:      true
---
___

```{r preamble, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = TRUE,
  message=FALSE, 
  warning=FALSE,
  fig.topcaption=TRUE, 
  fig.show="hold",
  fig.align="center",
  fig.width=7, 
  fig.height=4.6)


## Initiate 
## ... Packages
source(here::here("src/preamble.R"))

install.packages(setdiff(c("sf"), rownames(installed.packages())))
library(sf)

## ... Functions
source(here("src/def_paths.R"))
source(here("src/text_colour.R"))

## ... Files
l.file <- list(
  gf = path(l.path$data, "gf_original/regressions_ready_data2.dta"),
  state = path(l.path$data, "eia/shp/USA_States_Generalized.shp"),
  county = path(l.path$data, "eia/shp/USA_Counties_(Generalized).shp")
)

## ... Definitions
date <- format(Sys.Date(), "%Y%m%d")
# date <- "20211123"
fs::dir_create(path(l.path$out, date))
```

```{r theme, include=FALSE}

theme_maps <- function() {
  theme_void() +
  theme(legend.position = "right",
        legend.text = element_text(size=7),
        plot.caption = element_text(hjust=0))
} 
```

# Objective

This workbook forms a part of the Grandfathering project analysis.  It prepares a boiler retirement map.

The remainder of this workbook is organized as follows.  First, we import the necessary data.  Next, we clean the data while also providing a running commentary for replication.  Finally, we plot the map.


# Import

First, we import the grandfathering and spatial data.


## Grandfathering

We first import the grandfathering data.

```{r data-gf}

## Import GF dataset
df.gf <- read_dta(l.file$gf) %>%
  filter(!(year<1985 | year==2006 | year>2017)) %>%
  filter(plant_code!=10673) %>%                        ## Unit is in HI
  select(ORISPL = plant_code,
         BOILERID = boiler_id,
         STATE = states,
         FIPS_ST = fips_st,
         FIPS_CNTY = fips_cnty,
         YR = year,
         GF = grand_NSR_const,
         INSERVICE = inservice_y,
         SURVIVE = survive) %>%
  group_by(ORISPL, BOILERID, STATE, FIPS_ST, FIPS_CNTY) %>%
  summarise(GF = max(GF, na.rm=TRUE),
            INSERVICE = min(INSERVICE, na.rm=TRUE),
            SURVIVE = min(SURVIVE, na.rm=TRUE),
            .groups="drop")
```


## State shapefiles

The state spatial data is sourced from the [EIA](https://atlas.eia.gov/datasets/esri::usa-states-generalized).  While, only the shp file is named below, note that its import also requires equivalently named dbf, prj, and shx files in the folder.

```{r data-sf-state, fig.cap="State shapefile"}

## Import state shapefile
df.state <- read_sf(l.file$state) %>%
  filter(!(STATE_ABBR %in% c("AK","HI")))

## Display coordinate reference system
st_crs(df.state)

## Plot
ggplot(data=df.state) +
  geom_sf(color="grey40", fill="grey90", size=0.3) +
  coord_sf()
```


## County shapefile

The county spatial data is sourced from the [EIA](https://atlas.eia.gov/datasets/esri::usa-counties-generalized). While, only the shp file is named below, note that its import also requires equivalently named dbf, prj, and shx files in the folder.

```{r data-sf-county, fig.cap="County shapefile"}

## Import county shapefile
df.county <- read_sf(l.file$county) %>%
  filter(!(STATE_NAME %in% c("Alaska","Hawaii")))

## Display coordinate reference system
st_crs(df.county)

## Plot
ggplot(data=df.county) +
  geom_sf(color="grey40", fill="grey90", size=0.3) +
  coord_sf()
```


# Clean

We now clean the data by:

1. Aggregating the grandfathering data to the county level; and,
2. Merging county spatial data with the corresponding grandfathering data.


## Aggregate grandfathering to county

First, we summarize the grandfathering data at the county level.

```{r gf-county}

## Aggregate at the county level
df.gf_cnty <- df.gf %>%
  group_by(STATE, FIPS_ST, FIPS_CNTY, SURVIVE) %>%
  summarise(INSERVICE = min(INSERVICE, na.rm=TRUE),
            N = n(),
            .groups="drop")

## Summarize all boilers
df.gf_cnty_all <- df.gf_cnty %>%
  group_by(STATE, FIPS_ST, FIPS_CNTY) %>%
  summarise(INSERVICE = min(INSERVICE, na.rm=TRUE),
            N = sum(N, na.rm=TRUE),
            .groups="drop")

## Summarize retired boilers
df.gf_cnty_ret <- df.gf_cnty %>%
  filter(SURVIVE==0) %>%
  group_by(STATE, FIPS_ST, FIPS_CNTY) %>%
  summarise(INSERVICE_RET = min(INSERVICE, na.rm=TRUE),
            N_RET = sum(N, na.rm=TRUE),
            .groups="drop")

## Merge intermediate dataframes
df.gf_cnty <- df.gf_cnty_all %>%
  full_join(df.gf_cnty_ret, by=c("STATE","FIPS_ST","FIPS_CNTY")) %>%
  mutate(FIPS = paste0(formatC(FIPS_ST, format="d", width=2, flag="0"),
                       formatC(FIPS_CNTY, format="d", width=3, flag="0")),
         INSERVICE_GRP = cut(INSERVICE_RET, right=FALSE,
                             breaks=c(1900,1940,1950,1960,1970,1980,1990,2000,2030),
                             labels=c("<1940","1940-1949","1950-1959","1960-1969"
                                      ,"1970-1979","1980-1989","1990-1999",">2000"))) %>%
  select(FIPS, starts_with("INSERVICE"), starts_with("N"))

## Remove intermediate dataframes
rm(df.gf_cnty_all, df.gf_cnty_ret)  
```


## County-grandfathering merge

Next, we merge county grandfathering data with county geometries.

```{r gf-county-data, fig.cap="Grandfathering county data"}

## Import state shapefile
df.county <- df.county %>%
  left_join(df.gf_cnty, by=c("FIPS"))

## Plot
ggplot() +
  geom_sf(data=df.county, aes(fill=INSERVICE_GRP), color="grey90", size=0.3) +
  scale_fill_viridis_d(direction=-1, begin=0.1, end=0.85, na.value="grey70") +
  geom_sf(data=df.state, fill=NA, color="grey40", size=0.3) +
  coord_sf() +
  labs(title="Earliest in-service year of retired boilers by county",
       fill="In-service year") +
  theme_maps()

ggplot() +
  geom_sf(data=df.county, aes(fill=N_RET), color="grey90", size=0.3) +
  scale_fill_viridis_c(direction=-1, begin=0.1, end=0.85, na.value="grey70") +
  geom_sf(data=df.state, fill=NA, color="grey40", size=0.3) +
  coord_sf() +
  labs(title="Number of retired boilers by county",
       fill="Number of\nretirements") +
  theme_maps()
```

We can now convert the county data into centroids.

```{r county-centroids, fig.cap="Sulfur county centroids"}

## Merge county and sulfur data and convert to centroids
df.gf_cent <- df.county %>% 
  select(FID, OBJECTID, NAME, STATE_NAME, STATE_FIPS, CNTY_FIPS, FIPS, 
         starts_with("INSERVICE"), matches("^N(_|$)"), geometry) %>%
  filter(!is.na(N_RET)) %>%
  # st_as_sf() %>%
  st_centroid()


## Plot
ggplot() +
  geom_sf(data=df.state, fill="grey85", color="grey95", size=0.3) +
  geom_sf(data=df.gf_cent, aes(color=INSERVICE_GRP, size=N_RET)) +
  scale_color_viridis_d(end=0.9, alpha=0.4) +
  scale_size(breaks=c(5,10)) +
  coord_sf() +
  labs(#title="Boiler retirements by in-service year and size",
       color="In-service year\nof oldest boiler",
       size="Number of\nboilers") +
  theme_maps() +
  guides(color = guide_legend(order=1, override.aes=list(size=3.5, alpha=0.5)),
         size = guide_legend(order=2, override.aes=list(shape=1, alpha=0.5)))

# ggsave(path(l.path$out, date, "fig.retire_map.pdf"),
#        width=8, height=4.25, units="in")
```

